{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Dashboard</h2>

    {% if g.user.role == 'admin' %}
        <!-- DASHBOARD ADMIN -->
        <style>
            .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
            .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid; }
            .stat-card h3 { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem; text-transform: uppercase; }
            .stat-card .number { font-size: 2.5rem; font-weight: bold; color: #2c3e50; }
            .stat-card.blue { border-color: #3498db; }
            .stat-card.blue .number { color: #3498db; }
            .stat-card.green { border-color: #27ae60; }
            .stat-card.green .number { color: #27ae60; }
            .stat-card.orange { border-color: #f39c12; }
            .stat-card.orange .number { color: #f39c12; }
            .stat-card.purple { border-color: #9b59b6; }
            .stat-card.purple .number { color: #9b59b6; }
            .stat-card.red { border-color: #e74c3c; }
            .stat-card.red .number { color: #e74c3c; }
            .stat-card.teal { border-color: #1abc9c; }
            .stat-card.teal .number { color: #1abc9c; }
            .quick-actions { margin-top: 2rem; }
            .actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
            .action-card { padding: 1.5rem; text-align: center; border-radius: 8px; color: white; text-decoration: none; display: block; transition: transform 0.3s; }
            .action-card:hover { transform: translateY(-3px); text-decoration: none; color: white; }
            .action-card h5 { margin-bottom: 0.5rem; font-size: 1.1rem; }
            .action-card p { margin: 0; font-size: 0.9rem; opacity: 0.9; }
        </style>

        <div class="alert alert-info">
            <strong>üëã Selamat datang, Admin!</strong> Kelola sistem LMS dari panel ini.
        </div>

        <h3 class="mt-4">üìä Statistik Sistem</h3>
        <div class="stats-grid">
            <div class="stat-card blue">
                <h3>Total Siswa</h3>
                <div class="number">{{ total_students }}</div>
            </div>
            <div class="stat-card green">
                <h3>Total Guru</h3>
                <div class="number">{{ total_teachers }}</div>
            </div>
            <div class="stat-card orange">
                <h3>Total Materi</h3>
                <div class="number">{{ total_materials }}</div>
            </div>
            <div class="stat-card purple">
                <h3>Total Kuis</h3>
                <div class="number">{{ total_quizzes }}</div>
            </div>
            <div class="stat-card red">
                <h3>Total Tugas</h3>
                <div class="number">{{ total_tasks }}</div>
            </div>
            <div class="stat-card teal">
                <h3>Total Sertifikat</h3>
                <div class="number">{{ total_certificates }}</div>
            </div>
        </div>

        <div class="quick-actions">
            <h3>‚ö° Menu Cepat Admin</h3>
            <div class="actions-grid">
                <a href="{{ url_for('admin_certificates') }}" class="action-card" style="background: #f39c12;">
                    <h5>üèÜ Kelola Sertifikat</h5>
                    <p>Lihat & kelola semua sertifikat</p>
                </a>
                <a href="{{ url_for('create_certificate') }}" class="action-card" style="background: #e74c3c;">
                    <h5>‚ûï Buat Sertifikat</h5>
                    <p>Buat sertifikat baru untuk siswa</p>
                </a>
                <a href="{{ url_for('admin_users') }}" class="action-card" style="background: #3498db;">
                    <h5>üë• Data Users</h5>
                    <p>Lihat data guru dan siswa</p>
                </a>
                <a href="{{ url_for('admin_activities') }}" class="action-card" style="background: #27ae60;">
                    <h5>üìà Log Aktivitas</h5>
                    <p>Monitor aktivitas sistem</p>
                </a>
            </div>
        </div>

        <!-- Daftar Sertifikat Terbaru -->
        <div class="mt-5">
            <h3>üéì Sertifikat Terbaru</h3>
            <div class="card">
                <div class="card-body">
                    {% if recent_certificates %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Nomor Sertifikat</th>
                                    <th>Siswa</th>
                                    <th>Kelas</th>
                                    <th>Tanggal Terbit</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cert in recent_certificates %}
                                <tr>
                                    <td><strong>{{ cert.certificate_number }}</strong></td>
                                    <td>{{ cert.full_name or cert.username }}</td>
                                    <td>
                                        {% if cert.class_name %}
                                            <span class="badge bg-secondary">{{ cert.class_name }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ cert.issued_at.strftime('%d/%m/%Y') if cert.issued_at else '-' }}</small></td>
                                    <td>
                                        <a href="{{ url_for('view_certificate', cert_id=cert.id) }}" 
                                           class="btn btn-sm btn-info">Lihat</a>
                                        <a href="{{ url_for('edit_certificate', cert_id=cert.id) }}" 
                                           class="btn btn-sm btn-warning">Edit</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <a href="{{ url_for('admin_certificates') }}" class="btn btn-primary">
                            Lihat Semua Sertifikat ‚Üí
                        </a>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-certificate fa-3x mb-3 d-block"></i>
                        <p>Belum ada sertifikat yang dibuat.</p>
                        <a href="{{ url_for('create_certificate') }}" class="btn btn-primary">
                            Buat Sertifikat Pertama
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

    {% elif g.user.role == 'sensei' %}
        <!-- BAGIAN PILIH KELAS UNTUK SENSEI -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìã Pilih Kelas untuk Mengelola</h5>
            </div>
            <div class="card-body">
                {% if selected_class %}
                    <div class="alert alert-success d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Kelas yang dipilih:</strong> {{ selected_class.name }}
                            <br>
                            <small class="text-muted">{{ selected_class.description }}</small>
                        </div>
                        <a href="{{ url_for('clear_class_selection') }}" class="btn btn-sm btn-warning">
                            Ganti Kelas
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted mb-3">Silakan pilih kelas terlebih dahulu untuk mengelola materi, kuis, dan tugas:</p>
                    <div class="row">
                        {% for cls in all_classes %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">{{ cls.name }}</h5>
                                    <p class="card-text text-muted small">{{ cls.description }}</p>
                                    <a href="{{ url_for('select_class', class_id=cls.id) }}" 
                                       class="btn btn-primary btn-sm w-100">
                                        Pilih Kelas Ini
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12">
                            <p class="text-muted">Belum ada kelas tersedia.</p>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        {% if selected_class %}
        <!-- BAGIAN CRUD MATERI, KUIS, TUGAS (hanya tampil jika kelas sudah dipilih) -->
        <hr>
        <h3>üìö Materi</h3>
        <a href="{{ url_for('create_material') }}" class="btn btn-primary btn-sm mb-2">+ Tambah Materi</a>
        <ul class="list-group mb-4">
            {% for mat in mats %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('view_material', mid=mat.id) }}" class="fw-bold">{{ mat.title }}</a><br>
                    <small class="text-muted">{{ mat.created_at }}</small>
                </div>
                <div>
                    <a href="{{ url_for('edit_material', mid=mat.id) }}" class="btn btn-warning btn-sm">Edit</a>
                    <a href="{{ url_for('delete_material', mid=mat.id) }}" 
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Yakin ingin menghapus materi ini?')">Hapus</a>
                </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">Belum ada materi untuk kelas ini.</li>
            {% endfor %}
        </ul>

        <hr>
        <h3>üß† Kuis</h3>
        <a href="{{ url_for('create_quiz') }}" class="btn btn-primary btn-sm mb-2">+ Buat Kuis</a>
        <ul class="list-group mb-4">
            {% for quiz in quizzes %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">{{ quiz.title }}</span><br>
                    <small class="text-muted">{{ quiz.created_at }}</small>
                </div>
                <div>
                    <a href="{{ url_for('add_question', qid=quiz.id) }}" class="btn btn-secondary btn-sm">Tambah Pertanyaan</a>
                    <a href="{{ url_for('edit_quiz', qid=quiz.id) }}" class="btn btn-warning btn-sm">Edit</a>
                    <a href="{{ url_for('delete_quiz', qid=quiz.id) }}" 
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Yakin ingin menghapus kuis ini?')">Hapus</a>
                </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">Belum ada kuis untuk kelas ini.</li>
            {% endfor %}
        </ul>

        <hr>
        <h3>üìÑ Tugas</h3>
        <a href="{{ url_for('create_task') }}" class="btn btn-primary btn-sm mb-2">+ Buat Tugas</a>
        <ul class="list-group mb-4">
            {% for task in tasks %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">{{ task.title }}</span><br>
                    <small class="text-muted">Deadline: {{ task.due_date if task.due_date else 'Tidak ada deadline' }}</small>
                </div>
                <div>
                    <a href="{{ url_for('edit_task', tid=task.id) }}" class="btn btn-warning btn-sm">Edit</a>
                    <a href="{{ url_for('delete_task', tid=task.id) }}" 
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Yakin ingin menghapus tugas ini?')">Hapus</a>
                </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">Belum ada tugas untuk kelas ini.</li>
            {% endfor %}
        </ul>
        {% else %}
        <!-- Pesan jika belum memilih kelas -->
        <div class="alert alert-info mt-4">
            <strong>‚ÑπÔ∏è Info:</strong> Pilih kelas terlebih dahulu untuk mengelola materi, kuis, dan tugas.
        </div>
        {% endif %}

    {% else %}
        <!-- BAGIAN UNTUK SISWA -->
        <div class="alert alert-success">
            <strong>üëã Selamat datang, {{ g.user.full_name or g.user.username }}!</strong> Selamat belajar!
        </div>

        <hr>
        <h3>üìö Materi</h3>
        <ul class="list-group mb-4">
            {% for mat in mats %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('view_material', mid=mat.id) }}" class="fw-bold">{{ mat.title }}</a><br>
                    <small class="text-muted">{{ mat.created_at }}</small>
                </div>
                <div>
                    <a href="{{ url_for('view_material', mid=mat.id) }}" class="btn btn-info btn-sm">Lihat</a>
                </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">Belum ada materi.</li>
            {% endfor %}
        </ul>

        <hr>
        <h3>üß† Kuis</h3>
        <ul class="list-group mb-4">
            {% for quiz in quizzes %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">{{ quiz.title }}</span><br>
                    <small class="text-muted">{{ quiz.created_at }}</small>
                </div>
                <div>
                    <a href="{{ url_for('take_quiz', qid=quiz.id) }}" class="btn btn-success btn-sm">Kerjakan</a>
                </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">Belum ada kuis.</li>
            {% endfor %}
        </ul>

        <hr>
        <h3>üìÑ Tugas</h3>
        <ul class="list-group mb-4">
            {% for task in tasks %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">{{ task.title }}</span><br>
                    <small class="text-muted">Deadline: {{ task.due_date if task.due_date else 'Tidak ada deadline' }}</small>
                </div>
                <div>
                    <a href="{{ url_for('upload_task', tid=task.id) }}" class="btn btn-success btn-sm">Kumpulkan</a>
                </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">Belum ada tugas.</li>
            {% endfor %}
        </ul>

        <!-- LINK KE SERTIFIKAT SISWA -->
        <hr>
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">üèÜ Sertifikat Saya</h5>
                <p class="card-text">Lihat sertifikat yang telah Anda peroleh</p>
                <a href="{{ url_for('my_certificates') }}" class="btn btn-primary">Lihat Sertifikat</a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}