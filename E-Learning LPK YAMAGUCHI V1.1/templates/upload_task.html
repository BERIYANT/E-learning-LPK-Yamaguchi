{% extends "base.html" %}

{% block title %}Upload Tugas - {{ task.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('my_tasks') }}">Tugas Saya</a></li>
            <li class="breadcrumb-item active">Upload Tugas</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Info Tugas -->
        <div class="col-md-5">
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Detail Tugas</h5>
                </div>
                <div class="card-body">
                    <h5>{{ task.title }}</h5>
                    <hr>
                    <p><strong>Deskripsi:</strong></p>
                    <div class="border-start border-3 border-info ps-3">
                        {{ task.description|safe }}
                    </div>
                    
                    <hr>
                    
                    {% if task.due_date %}
                    <p class="mb-0">
                        <i class="bi bi-alarm text-danger"></i> 
                        <strong>Deadline:</strong> 
                        <span class="badge bg-danger">{{ task.due_date.strftime('%d %B %Y') }}</span>
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- Info Submission Sebelumnya -->
            {% if existing_submission %}
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i> Submission Sebelumnya
                    </h6>
                </div>
                <div class="card-body">
                    <p><strong>Status:</strong> Sudah pernah mengumpulkan</p>
                    <p><strong>Tanggal Submit:</strong><br>
                        {{ existing_submission.submitted_at.strftime('%d %B %Y, %H:%M') if existing_submission.submitted_at else '-' }}
                    </p>
                    
                    {% if existing_submission.file_path %}
                    <p><strong>File:</strong><br>
                        <a href="{{ url_for('static', filename='uploads/' + existing_submission.file_path.split('/')[-1]) }}" 
                           target="_blank" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-download"></i> Download File Lama
                        </a>
                    </p>
                    {% endif %}

                    {% if existing_submission.score %}
                        <hr>
                        <div class="alert alert-success mb-0">
                            <h6><i class="bi bi-star"></i> Sudah Dinilai</h6>
                            <p class="mb-2"><strong>Nilai:</strong> <span class="badge bg-success fs-5">{{ existing_submission.score }}</span></p>
                            {% if existing_submission.feedback %}
                            <p class="mb-0"><strong>Feedback:</strong><br>{{ existing_submission.feedback }}</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <hr>
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-clock"></i> Menunggu penilaian dari guru
                        </div>
                    {% endif %}

                    <hr>
                    <p class="text-danger mb-0">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Perhatian:</strong> Upload ulang akan mengganti file sebelumnya dan menghapus nilai (jika sudah dinilai).
                    </p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Form Upload -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-upload"></i> 
                        {{ 'Upload Ulang Tugas' if existing_submission else 'Upload Tugas' }}
                    </h5>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages() %}
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    {% if existing_submission and existing_submission.score %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>Peringatan!</strong> Tugas ini sudah dinilai dengan nilai <strong>{{ existing_submission.score }}</strong>. 
                            Jika Anda upload ulang, nilai akan dihapus dan tugas akan dinilai ulang oleh guru.
                        </div>
                    {% endif %}

                    <form method="POST" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="file" class="form-label">
                                Pilih File <span class="text-danger">*</span>
                            </label>
                            <input type="file" 
                                   class="form-control form-control-lg" 
                                   id="file" 
                                   name="file" 
                                   required
                                   accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.rar,.jpg,.jpeg,.png">
                            <small class="form-text text-muted">
                                Format yang diizinkan: PDF, Word, PowerPoint, Excel, ZIP, RAR, atau gambar (JPG, PNG)
                                <br>Maksimal ukuran file: 4 MB
                            </small>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb"></i> 
                            <strong>Tips:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Pastikan nama file mudah diidentifikasi</li>
                                <li>Periksa kembali file sebelum upload</li>
                                <li>Upload sebelum deadline</li>
                                <li>Jika ada masalah, hubungi guru</li>
                            </ul>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('my_tasks') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Batal
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-cloud-upload"></i> 
                                {{ 'Upload Ulang' if existing_submission else 'Upload Tugas' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Panduan -->
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-question-circle"></i> Panduan Upload</h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li>Klik tombol "Choose File" atau "Pilih File"</li>
                        <li>Pilih file tugas yang sudah Anda kerjakan</li>
                        <li>Pastikan format file sesuai</li>
                        <li>Klik tombol "Upload Tugas"</li>
                        <li>Tunggu konfirmasi upload berhasil</li>
                        <li>Cek status tugas di halaman "Tugas Saya"</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}