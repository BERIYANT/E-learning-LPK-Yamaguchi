{% extends 'base.html' %}
{% block title %}Edit Profil{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_profile.css') }}">
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
{% endblock %}

{% block content %}
<div class="card shadow p-4">
  <h3 class="mb-4">Edit Profil</h3>

  <form method="post" id="profileForm">
    <div class="row">
      <div class="col-md-4 text-center">
        <div class="avatar-preview mb-3">
          {% if user.avatar %}
            <img src="{{ url_for('static', filename='uploads/' ~ user.avatar) }}" 
                 class="avatar-display" 
                 alt="Avatar"
                 id="current-avatar">
          {% else %}
            <img src="{{ url_for('static', filename='default_avatar.png') }}" 
                 class="avatar-display" 
                 alt="Avatar Default"
                 id="current-avatar">
          {% endif %}
        </div>
        
        <input type="file" 
               id="avatar-input" 
               class="form-control mb-2" 
               accept="image/png,image/jpeg,image/jpg,image/gif">
        
        <small class="text-muted d-block mb-2">Format: PNG, JPG, JPEG, GIF (Max 4MB)</small>
        <small class="text-muted d-block">Foto akan di-crop otomatis dengan rasio 3:4</small>
        
        <!-- Preview setelah crop -->
        <div id="preview-container">
          <p class="text-success mt-3"><strong>Preview:</strong></p>
          <img id="avatar-preview" alt="Preview">
          <p class="text-muted small mt-2">âœ“ Siap untuk disimpan</p>
        </div>
        
        <!-- Hidden input untuk menyimpan cropped image (base64) -->
        <input type="hidden" name="avatar" id="avatar-data">
      </div>

      <div class="col-md-8">
        <div class="mb-3">
          <label class="form-label">Nama Lengkap</label>
          <input type="text" 
                 name="full_name" 
                 value="{{ user.full_name or '' }}" 
                 class="form-control"
                 placeholder="Masukkan nama lengkap">
        </div>

        <div class="mb-3">
          <label class="form-label">Bio</label>
          <textarea name="bio" 
                    class="form-control" 
                    rows="4" 
                    placeholder="Ceritakan tentang diri Anda...">{{ user.bio or '' }}</textarea>
        </div>

        <button type="submit" class="btn btn-success">
          <i class="fas fa-save"></i> Simpan Perubahan
        </button>
        <a href="{{ url_for('profile') }}" class="btn btn-secondary">
          <i class="fas fa-times"></i> Batal
        </a>
      </div>
    </div>
  </form>
</div>

<!-- Modal untuk Crop Image -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crop Foto Profil (Rasio 3:4)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="img-container">
          <img id="image-to-crop" src="" alt="Image to crop">
        </div>
        <div class="crop-buttons text-center">
          <button type="button" class="btn btn-secondary" id="rotateLeft">
            <i class="fas fa-undo"></i> Putar Kiri
          </button>
          <button type="button" class="btn btn-secondary" id="rotateRight">
            <i class="fas fa-redo"></i> Putar Kanan
          </button>
          <button type="button" class="btn btn-secondary" id="flipHorizontal">
            <i class="fas fa-arrows-alt-h"></i> Flip Horizontal
          </button>
          <button type="button" class="btn btn-secondary" id="flipVertical">
            <i class="fas fa-arrows-alt-v"></i> Flip Vertical
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-success" id="cropButton">
          <i class="fas fa-check"></i> Crop & Gunakan
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Cropper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script src="{{ url_for('static', filename='js/edit_profile.js') }}"></script>
{% endblock %}